# get prerequirements from svn
prebuild windows x64:
  stage: prebuild
  tags:
    - windows
  cache:
    key: prerequirements-windows-x64
    paths:
      - scilab/Visual-Studio-settings/
      - scilab/bin/
      - scilab/java/
      - scilab/libs/
      - scilab/modules/
      - scilab/thirdparty/
      - scilab/tools/
    policy: push
  script:
    - svn checkout --force --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/Windows_x64/ scilab
  when: manual


# get prerequirements from svn
prebuild linux x86_64:
  stage: prebuild
  tags:
    - linux
  cache:
    key: prerequirements-linux-x86_64
    paths:
      - scilab/java/
      - scilab/lib/
      - scilab/modules/
      - scilab/thirdparty/
      - scilab/usr/
    policy: push
  script:
    - svn checkout --force --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/linux_x64/ scilab
  when: manual


# create docker images for builders 
create docker images:
  stage: prebuild
  image: docker
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/scilab/scilab:builder_linux - < /.gitlab-ci/Dockerfile.linux
    - docker push $CI_REGISTRY/scilab/scilab:builder_linux
# Docker windows not supported yet
#  - docker build -t $CI_REGISTRY/scilab/scilab:builder_windows - < /.gitlab-ci/Dockerfile.windows
#  - docker push $CI_REGISTRY/scilab/scilab:builder_windows
  only:
    changes:
      - /.gitlab-ci.yml
      - /.gitlab-ci/Dockerfile*


# cleanup old builds from runners
cleanup old linux builds:
  stage: prebuild
  tags:
    - linux x86_64
    - g++
    - gfortran
    - openjdk 8
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    - set -e -x
    # Remove any previous tarball
    - rm -fr scilab-*.tar.gz
    # Remove install dir older than 3 days
    - |
      find /tmp -maxdepth 1 -mtime +2 -name "scilab-*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        chmod -R +w "$i" && rm -rf "$i";
      done
    # Remove TMPDIRs older than 1 day
    - |
      find /tmp -maxdepth 1 -mtime +0 -name "SCI_TMP*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        [ -w "$i" ] && rm -rf "$i";
      done

# cleanup old builds from runners
cleanup old windows builds:
  stage: prebuild
  tags:
    - windows x64
    - visual studio 2017
    - intel oneAPI
    - openjdk 8
    - innosetup 6
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    # Remove install dir older than 3 days
    - del /f /q /s scilab-*.exe |cmd /c ""
    - del /f /q /s scilab-*\ |cmd /c ""
    # Remove TMPDIRs older than 1 day
    - forfiles -p "%temp%" -m "SCI_TMP*" -d -1 -c "cmd /c IF @isdir == TRUE rd /S /Q @path" |cmd /c ""


# manuel clean
clean linux:
  stage: prebuild
  tags:
    - linux x86_64
    - g++
    - gfortran
    - openjdk 8
  variables:
      GIT_CLEAN_FLAGS: -fxd
  script: echo "git clean succeeded"
  when: manual
clean windows:
  stage: prebuild
  tags:
    - windows x64
    - visual studio 2017
    - intel oneAPI
    - openjdk 8
    - innosetup 6
  variables:
      GIT_CLEAN_FLAGS: -fxd
  script: echo "git clean succeeded"
  when: manual

