# create docker images for builders 
create_docker_image:
  stage: prebuild
  image: docker
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/scilab/linux_runner:$CI_COMMIT_REF_SLUG - < /.gitlab-ci/Dockerfile.linux
    - docker push $CI_REGISTRY/scilab/linux_runner:$CI_COMMIT_REF_SLUG
# Docker windows not supported yet
#  - docker build -t $CI_REGISTRY/scilab/windows_runner:$CI_COMMIT_REF_SLUG - < /.gitlab-ci/Dockerfile.windows
#  - docker push $CI_REGISTRY/scilab/windows_runner:$CI_COMMIT_REF_SLUG
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - /.gitlab-ci/Dockerfile*


# cleanup old builds from runners
cleanup_old_linux_builds:
  stage: prebuild
  tags:
    - linux x86_64
    - scilab
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    - set -e -x
    # Remove any previous tarball
    - rm -fr scilab-*.tar.gz
    # Remove install dir older than 3 days
    - |
      find /tmp -maxdepth 1 -mtime +2 -name "scilab-*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        chmod -R +w "$i" && rm -rf "$i";
      done
    # Remove TMPDIRs older than 1 day
    - |
      find /tmp -maxdepth 1 -mtime +0 -name "SCI_TMP*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        [ -w "$i" ] && rm -rf "$i";
      done


# cleanup old builds from runners
cleanup_old_windows_builds:
  stage: prebuild
  tags:
    - windows x64
    - scilab
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    # Remove any previous installer
    - del /f /q /s scilab-*.exe |cmd /c ""
    # Remove TMPDIRs older than 1 day
    - forfiles -p "%temp%" -m "SCI_TMP*" -d -1 -c "cmd /c IF @isdir == TRUE rd /S /Q @path" |cmd /c ""


# manuel clean
clean_linux:
  stage: prebuild
  tags:
    - linux x86_64
    - scilab
  variables:
      GIT_CLEAN_FLAGS: -fxd
  script: echo "git clean succeeded"
  when: manual
clean_windows:
  stage: prebuild
  tags:
    - windows x64
    - scilab
  variables:
      GIT_CLEAN_FLAGS: -fxd
  script: echo "git clean succeeded"
  when: manual

# patch, copy, modify files before building a release
prepare_release_files:
  stage: prebuild
  tags:
    - linux
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "not yet implemented, should patch version numbers against tag"
  artifacts:
    paths:
      - scilab/modules/core/includes/version.h.vc
      - scilab/modules/core/includes/version.h.in
