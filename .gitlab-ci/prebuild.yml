# get prerequirements from svn
prebuild windows x64:
  stage: prebuild
  tags:
    - windows
  cache:
    key: prerequirements-windows-x64
    paths:
      - scilab/Visual-Studio-settings/
      - scilab/bin/
      - scilab/java/
      - scilab/libs/
      - scilab/modules/
      - scilab/thirdparty/
      - scilab/tools/
    policy: push
  script:
    - svn checkout --force --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/Windows_x64/ scilab
  when: manual


# get prerequirements from svn
prebuild linux x86_64:
  stage: prebuild
  tags:
    - linux
  cache:
    key: prerequirements-linux-x86_64
    paths:
      - scilab/java/
      - scilab/lib/
      - scilab/modules/
      - scilab/thirdparty/
      - scilab/usr/
    policy: push
  script:
    - svn checkout --force --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/linux_x64/ scilab
  when: manual


# create docker images for builders 
create docker images:
  stage: prebuild
  image: docker
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/scilab/scilab:builder_linux - < /.gitlab-ci/Dockerfile.linux
    - docker push $CI_REGISTRY/scilab/scilab:builder_linux
# Docker windows not supported yet
#  - docker build -t $CI_REGISTRY/scilab/scilab:builder_windows - < /.gitlab-ci/Dockerfile.windows
#  - docker push $CI_REGISTRY/scilab/scilab:builder_windows
  only:
    changes:
      - /.gitlab-ci.yml
      - /.gitlab-ci/Dockerfile*


# cleanup old builds from runners
cleanup old linux builds:
  stage: prebuild
  tags:
    - linux x86_64
    - g++
    - gfortran
    - openjdk 8
  script:
    # Remove install dir older than 3 days and TMPDIRs older than 1 day
    - |
      find /tmp -maxdepth 1 -mtime +2 -name "scilab-*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        chmod -R +w "$i" && rm -rf "$i";
      done
      find /tmp -maxdepth 1 -mtime +0 -name "SCI_TMP*" -type d -print0 |\
      while IFS= read -r -d '' i ; do
        [ -w "$i" ] && rm -rf "$i";
      done


# manuel clean
clean linux:
  stage: prebuild
  tags:
    - linux x86_64
    - g++
    - gfortran
    - openjdk 8
  script:
    - cd scilab; make distclean
  when: manual
clean windows:
  stage: prebuild
  tags:
    - windows x64
    - visual studio 2017
    - intel oneAPI
    - openjdk 8
    - innosetup 6
  script:
    - devenv scilab\Scilab.sln /clean "Release|x64"
  when: manual

