# build scilab using a windows runner
.build_windows_x64:
  stage: build
  needs: [cleanup_old_windows_builds]
  tags:
    - windows_x64
    - scilab
  variables:
      GIT_CLEAN_FLAGS: none
      ARCH: x64
  script: call .gitlab-ci\build.bat
  artifacts:
    paths:
      - log*.txt
      - scilab-*.exe
    reports:
      dotenv: build.env
    when: always

# build an intermediate version
build_windows_x64_branch:
  extends: .build_windows_x64
  variables:
      SCI_VERSION_STRING: scilab-branch-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_REF_PROTECTED

# build a release
build_windows_x64_release:
  extends: .build_windows_x64
  needs:
    - prepare_release_files
  variables:
      SCI_VERSION_STRING: scilab-$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG



# build scilab using a linux runner
.build_x86_64-linux-gnu:
  stage: build
  needs: [cleanup_old_linux_builds]
  tags:
    - x86_64-linux-gnu
    - scilab
  variables:
      GIT_CLEAN_FLAGS: none
  script: bash -x -e .gitlab-ci/build.sh
  artifacts:
    paths:
      - log*.txt
      - scilab-*.tar.gz
    reports:
      dotenv: build.env
    when: always

# build an intermediate version
build_x86_64-linux-gnu_branch:
  extends: .build_x86_64-linux-gnu
  variables:
      SCI_VERSION_STRING: scilab-branch-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_REF_PROTECTED

# build a release
build_x86_64-linux-gnu_release:
  extends: .build_x86_64-linux-gnu
  needs:
    - prepare_release_files
  variables:
      SCI_VERSION_STRING: scilab-$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG


# build scilab using the docker image
#build_docker:
#  stage: build
#  image: $CI_REGISTRY/scilab/scilab:builder_linux
#  tags:
#    - docker
#    - scilab
#  variables:
#      GIT_CLEAN_FLAGS: none
#      SCI_VERSION_STRING: scilab-branch-$CI_COMMIT_BRANCH
#  script: bash -x -e .gitlab-ci/build.sh
#  artifacts:
#    paths:
#      - log*.txt
#      - $SCI_VERSION_STRING.tar.gz
