# build scilab using a windows runner
build windows x64:
  stage: build
  tags:
    - windows x64
    - visual studio 2017
    - intel oneAPI
    - openjdk 8
    - innosetup 6
  cache:
    key: prerequirements-windows-x64
    policy: pull
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    # likely cached
    - svn checkout --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/Windows_x64/ scilab
    # use devenv for intel oneAPI support 
    - cd scilab
    - call "%VS2017INSTALLDIR%\VC\Auxiliary\Build\vcvarsall.bat" x64
    - setx SCILAB_JDK64 %JAVA_HOME%
    - env
    - devenv Scilab.sln /Build Release /Project WScilex /ProjectConfig "Release|x64" /out build.log
    - call bin\scilab.bat -f tools\innosetup\Create_ISS.sce
    - '"C:\Program Files (x86)\Inno Setup 6\iscc.exe" tools\innosetup\Scilab.iss'

# build scilab using a linux runner
build linux x86_64:
  stage: build
  tags:
    - linux x86_64
    - g++
    - gfortran
    - openjdk 8
  cache:
    key: prerequirements-linux-x86_64
    policy: pull
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    # likely cached
    - svn checkout --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/linux_x64/ scilab
    # configure & make
    - cd scilab
    - ./configure --prefix=''
    - make -j
    - make install DESTDIR=scilab-branch-${CI_COMMIT_REF_NAME}-${CI_COMMIT_TIMESTAMP}
  artifacts:
    paths:
      - scilab-branch-${CI_COMMIT_REF_NAME}-${CI_COMMIT_TIMESTAMP}

# build scilab using the docker image
build docker:
  stage: build
  image: $CI_REGISTRY/scilab/scilab:builder_linux
  tags:
    - docker
  cache:
    key: prerequirements-linux-x86_64
    policy: pull
  variables:
      GIT_CLEAN_FLAGS: none
  script:
    # likely cached
    - svn checkout --username anonymous --password Scilab svn://svn.scilab.org/scilab/trunk/Dev-Tools/SE/Prerequirements/linux_x64/ scilab
    # configure & make
    - cd scilab
    - ./configure --prefix=''
    - make -j
    - make install DESTDIR=scilab-branch-${CI_COMMIT_REF_NAME}-${CI_COMMIT_TIMESTAMP}
  artifacts:
    paths:
      - scilab-branch-${CI_COMMIT_REF_NAME}-${CI_COMMIT_TIMESTAMP}
