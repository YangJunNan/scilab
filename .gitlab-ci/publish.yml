# Scilab ( http://www.scilab.org/ ) - This file is part of Scilab
# Copyright (C) Dassault Systemes - 2022 - Clement DAVID
#
#
# This YAML file describe the publish stage of the CI. This stage is used to 
# extract artifacts and publish them to other websites.
#


release:
  stage: publish
  tags: [x86_64-linux-gnu, docker, scilab]
  variables:
      GIT_CLEAN_FLAGS: none
  dependencies: []
  needs:
    # build artifacts
    - sign_tool
    - job: x86_64-linux-gnu_build_nightly
      optional: true
    - job: x86_64-linux-gnu_build_release
      optional: true
    # get env information used to build scilab
    - job: x86_64-linux-gnu_set_release_env
      optional: true
    - job: x86_64-linux-gnu_set_branch_env
      optional: true
  script:
    - echo "FIXME nothing to deploy"
  when: manual

# generate index.html files for each directory in public/
index_gitlab_pages:
  stage: publish
  tags: [x86_64-linux-gnu, docker, scilab]
  variables:
      GIT_CLEAN_FLAGS: none
  dependencies: []
  needs: 
    - publish_help_jar
    - build_doxygen
    - build_help_web
    - build_javadoc
  when: always
  script:
    - mkdir public ||true
    - |
      find public -type d -print0 | while IFS= read -r -d '' d; do
        cd $CI_PROJECT_DIR/$d;
        echo '<html><body>' >index.html;
        find . -name '*.html' -printf '<a href="%p">%p</a><br/>\n' >>index.html;
        echo '</body></html>' >>index.html;
      done;
  artifacts:
    paths:
      - public
